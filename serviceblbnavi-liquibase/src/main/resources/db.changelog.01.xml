<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">
    <changeSet author="mradzikowski" id="1">
        <createTable tableName="Person">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="mradzikowski" id="2">
        <createTable tableName="Complex">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="person_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="person_id" baseTableName="Complex"
                                 referencedColumnNames="id" referencedTableName="Person"
                                 constraintName="FK_Complex_Person" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="3">
        <createTable tableName="Building">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="minimumFloor" type="TINYINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="degree" type="DOUBLE" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="complex_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="complex_id" baseTableName="Building"
                                 referencedColumnNames="id" referencedTableName="Complex"
                                 constraintName="FK_Building_Complex" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="4">
        <createTable tableName="Floor">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="number" type="TINYINT">
                <constraints nullable="false"/>
            </column>
            <column name="bitmap" type="MEDIUMBLOB">
                <constraints nullable="false"/>
            </column>
            <column name="mToPix" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="startZoom" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="building_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="building_id" baseTableName="Floor"
                                 referencedColumnNames="id" referencedTableName="Building"
                                 constraintName="FK_Floor_Building" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="5">
        <createTable tableName="Beacon">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="mac" type="VARCHAR(12)">
                <constraints nullable="false"/>
            </column>
            <column name="x" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="y" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="z" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="floor_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="floor_id" baseTableName="Beacon"
                                 referencedColumnNames="id" referencedTableName="Floor"
                                 constraintName="FK_Beacon_Floor" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="6">
        <createTable tableName="Waypoint">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="x" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="y" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="timeToCheckout" type="INT" defaultValueNumeric="60">
                <constraints nullable="false"/>
            </column>
            <column name="distance" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="details" type="VARCHAR(255)"/>
            <column name="floor_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="floor_id" baseTableName="Waypoint"
                                 referencedColumnNames="id" referencedTableName="Floor"
                                 constraintName="FK_Waypoint_Floor" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="7">
        <createTable tableName="Vertex">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="x" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="y" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="isFloorDownChangeable" type="BOOL" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="isFloorUpChangeable" type="BOOL" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="floor_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="floor_id" baseTableName="Vertex"
                                 referencedColumnNames="id" referencedTableName="Floor"
                                 constraintName="FK_Vertex_Floor" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <changeSet author="mradzikowski" id="8">
        <modifyDataType tableName="Waypoint" columnName="details" newDataType="VARCHAR(10000)"/>
    </changeSet>
    <changeSet author="mradzikowski" id="9">
        <createTable tableName="Goal">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="building_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="vertex_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="building_id" baseTableName="Goal"
                                 referencedColumnNames="id" referencedTableName="Building"
                                 constraintName="FK_Goal_Building" onDelete="CASCADE" onUpdate="CASCADE"/>
        <addForeignKeyConstraint baseColumnNames="vertex_id" baseTableName="Goal"
                                 referencedColumnNames="id" referencedTableName="Vertex"
                                 constraintName="FK_Goal_Vertex" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="10">
        <createTable tableName="Edge">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="weight" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="source_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="target_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="source_id" baseTableName="Edge"
                                 referencedColumnNames="id" referencedTableName="Vertex"
                                 constraintName="FK_Edge_Vertex_source" onDelete="CASCADE" onUpdate="CASCADE"/>
        <addForeignKeyConstraint baseColumnNames="target_id" baseTableName="Edge"
                                 referencedColumnNames="id" referencedTableName="Vertex"
                                 constraintName="FK_Edge_Vertex_target" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="11">
        <createTable tableName="Exit">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="latitude" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="longitude" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="in" type="BOOL" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="out" type="BOOL" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="vertex_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="vertex_id" baseTableName="Exit"
                                 referencedColumnNames="id" referencedTableName="Vertex"
                                 constraintName="FK_Exit_Vertex" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    <changeSet author="mradzikowski" id="12">
        <createTable tableName="BuildingConnection">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="distance" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="source_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="target_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="source_id" baseTableName="BuildingConnection"
                                 referencedColumnNames="id" referencedTableName="Exit"
                                 constraintName="FK_BuildingConnection_Exit_source" onDelete="CASCADE" onUpdate="CASCADE"/>
        <addForeignKeyConstraint baseColumnNames="target_id" baseTableName="BuildingConnection"
                                 referencedColumnNames="id" referencedTableName="Exit"
                                 constraintName="FK_BuildingConnection_Exit_target" onDelete="CASCADE" onUpdate="CASCADE"/>

    </changeSet>
    <changeSet id="13" author="mkoszalka">
        <addColumn tableName="Person">
            <column name="authToken" type="VARCHAR(32)"/>
        </addColumn>
    </changeSet>
    <changeSet id="14" author="mkoszalka">
        <dropNotNullConstraint tableName="Floor" columnName="bitmap" columnDataType="MEDIUMBLOB"/>
        <dropNotNullConstraint tableName="Floor" columnName="mToPix" columnDataType="DOUBLE"/>
        <dropNotNullConstraint tableName="Floor" columnName="startZoom" columnDataType="DOUBLE"/>
        <addColumn tableName="Beacon">
            <column name="minor" type="INT"/>
            <column name="major" type="INT"/>
        </addColumn>
    </changeSet>
    <changeSet id="15" author="mkoszalka">
        <renameColumn tableName="Floor" oldColumnName="number" newColumnName="level" columnDataType="TINYINT"/>
        <renameColumn tableName="Exit" oldColumnName="in" newColumnName="exitIn" columnDataType="TINYINT"/>
        <renameColumn tableName="Exit" oldColumnName="out" newColumnName="exitOut" columnDataType="TINYINT"/>
    </changeSet>
    <changeSet id="16" author="mkoszalka">
        <renameTable oldTableName="Exit" newTableName="BuildingExit"/>
    </changeSet>
    
    <changeSet id="17" author="gkonupek">
        <modifyDataType tableName="Beacon" columnName="mac" newDataType="VARCHAR(17)"/>
    </changeSet>
    
    <changeSet id="18" author="gkonupek">
        <dropColumn tableName="Vertex" columnName="isFloorUpChangeable"/>
        <dropColumn tableName="Vertex" columnName="isFloorDownChangeable"/>
    </changeSet>
    
    <changeSet id="19" author="gkonupek">
        <createView viewName="VertexFloorChangeabilityView" replaceIfExists="true">
            <![CDATA[
            select v.id as vertex_id,
            (select count(*) > 0 from Vertex v2
            left join Edge e on (e.source_id = v2.id)
            left join Vertex targetV on (targetV.id = e.target_id)
            left join Floor targetFloor on (targetFloor.id = targetV.floor_id)
            left join Floor sourceFloor on (sourceFloor.id = v2.floor_id)
            where sourceFloor.level > targetFloor.level and v2.id = v.id) as isFloorDownChangeable,
            (select count(*) > 0 from Vertex v3 left join Edge e on (e.source_id = v3.id)
            left join Vertex targetV on (targetV.id = e.target_id)
            left join Floor targetFloor on (targetFloor.id = targetV.floor_id)
            left join Floor sourceFloor on (sourceFloor.id = v3.floor_id)
            where sourceFloor.level < targetFloor.level and v3.id = v.id) as isFloorUpChangeable
            from Vertex v
            ]]>
        </createView>
    </changeSet>
    
    <changeSet id="20" author="gkonupek">
        <addColumn tableName="Building">
            <column name="configuration" type="LONGTEXT"/>
            <column name="configurationChecksum" type="VARCHAR(64)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="21" author="gkonupek">
        <addColumn tableName="Person">
            <column name="password" type="VARCHAR(128)"/>
            <column name="salt" type="VARCHAR(16)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="22" author="gkonupek">
        <createTable tableName="GoalSelection">
            <column autoIncrement="true" type="INT" name="id">
                <constraints primaryKey="true"/>
            </column>
            <column type="VARCHAR(255)" name="device">
                <constraints nullable="false"/>
            </column>
            <column type="DOUBLE" name="x"/>
            <column type="DOUBLE" name="y"/>
            <column type="INT" name="floorLevel"/>
            <column type="TIMESTAMP" name="creationDateTimestamp">
                <constraints nullable="false"/>
            </column>
            <column type="INT" name="goal_id"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="goal_id" baseTableName="GoalSelection"
                                 referencedColumnNames="id" referencedTableName="Goal"
                                 constraintName="FK_GoalSelection_Goal" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    
    <changeSet id="23" author="gkonupek">
        <createTable tableName="WaypointVisit">
            <column autoIncrement="true" type="INT" name = "id">
                <constraints primaryKey="true"/>
            </column>
            <column type="VARCHAR(255)" name="device">
                <constraints nullable="false"/>
            </column>
            <column type="TIMESTAMP" name="creationDateTimestamp">
                <constraints nullable="false"/>
            </column>
            <column type="INT" name="waypoint_id"/> 
        </createTable>
        <addForeignKeyConstraint baseColumnNames="waypoint_id" baseTableName="WaypointVisit"
                                 referencedColumnNames="id" referencedTableName="Waypoint"
                                 constraintName="FK_WaypointVisit_Waypoint" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    
    <changeSet id="24" author="gkonupek">
        <addColumn tableName="Goal">
            <column name="inactive" type="BOOL" defaultValue="0"/>
        </addColumn>
        <addColumn tableName="Vertex">
            <column name="inactive" type="BOOL" defaultValue="0"/>
        </addColumn>
        <addColumn tableName="Waypoint">
            <column name="inactive" type="BOOL" defaultValue="0"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="25" author="gkonupek">
        <addUniqueConstraint tableName="Complex" columnNames="name"/>
    </changeSet>
    
    <changeSet id="27" author="gkonupek">
        <createTable tableName="ACL_Complex">
            <column autoIncrement="true" type="INT" name="id">
                <constraints primaryKey="true"/>
            </column>
            <column name="person_id" type="INT"/>
            <column name="complex_id" type="INT"/>
            <column name="role" type="SET('READ', 'CREATE', 'UPDATE', 'DELETE')"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="person_id" baseTableName="ACL_Complex"
                                 referencedColumnNames="id" referencedTableName="Person"
                                 constraintName="FK_ACL_Complex_Person" onDelete="CASCADE" onUpdate="CASCADE"/>
        <addForeignKeyConstraint baseColumnNames="complex_id" baseTableName="ACL_Complex"
                                 referencedColumnNames="id" referencedTableName="Complex"
                                 constraintName="FK_ACL_Complex_Complex" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    
    <changeSet id="28" author="gkonupek">
        <dropForeignKeyConstraint baseTableName="Complex" constraintName="FK_Complex_Person"/>
    </changeSet>
    
    <changeSet id="29" author="gkonupek">
        <dropColumn tableName="Complex" columnName="person_id"/>
    </changeSet>
    
    <changeSet id="30" author="gkonupek">
        <createTable tableName="Role">
            <column autoIncrement="true" type="INT" name="id">
                <constraints primaryKey="true"/>
            </column>
            <column type="VARCHAR(255)" name="name"/>
        </createTable>
        <addColumn tableName="ACL_Complex">
            <column name="role_id" type="INT"/>
        </addColumn>
        <dropColumn tableName="ACL_Complex" columnName="role"/>
        <addForeignKeyConstraint baseColumnNames="role_id" baseTableName="ACL_Complex"
                                 referencedColumnNames="id" referencedTableName="Role"
                                 constraintName="FK_ACL_Complex_Role" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    
    <changeSet id="31" author="gkonupek">
        <renameTable oldTableName="Role" newTableName="Permission"/>
    </changeSet>
    
    <changeSet id="32" author="gkonupek">
        <renameColumn tableName="ACL_Complex" oldColumnName="role_id" newColumnName="permission_id" columnDataType="INT"/>
        <dropForeignKeyConstraint baseTableName="ACL_Complex" constraintName="FK_ACL_Complex_Role"/>
        <addForeignKeyConstraint baseColumnNames="permission_id" baseTableName="ACL_Complex"
                                 referencedColumnNames="id" referencedTableName="Permission"
                                 constraintName="FK_ACL_Complex_Permission" onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>
    
    <changeSet id="33" author="gkonupek">
        <addUniqueConstraint tableName="Permission" columnNames="name"/>
    </changeSet>
    
    <changeSet id="34" author="gkonupek">
        <insert tableName="Permission">
            <column name="name">READ</column>
        </insert>
        <insert tableName="Permission">
            <column name="name">UPDATE</column>
        </insert>
        <insert tableName="Permission">
            <column name="name">CREATE</column>
        </insert>
        <insert tableName="Permission">
            <column name="name">DELETE</column>
        </insert>
    </changeSet>
    
    <changeSet id="35" author="gkonupek">
        <addColumn tableName="Waypoint">
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="36" author="gkonupek">
        <addColumn tableName="Floor">
            <column name="bitmapWidth" type="INT"/>
            <column name="bitmapHeight" type="INT"/>
        </addColumn>
    </changeSet>
    
</databaseChangeLog>
